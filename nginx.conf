# nginx.conf

# Use host.docker.internal to connect from the container to your host machine
upstream frontend {
    server host.docker.internal:5173; # Your Vue/Vite development server
}

upstream backend {
    server host.docker.internal:8000; # Your Python/Uvicorn server
}

server {
    listen 8080;
    server_name localhost;

    # Location block for the frontend (default catch-all)
    # Handles all requests that don't match other specific location blocks.
    location / {
        proxy_pass http://frontend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Required for Vite's Hot Module Replacement (HMR) via WebSockets
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
    location = /chat {
        # Internally rewrite the URL to include the trailing slash
        # and process it with the corresponding location block.
        # 'last' tells Nginx to restart the search for a location block
        # with the new URL (/chat/).
        rewrite ^ /chat/ last;
    }
    location /chat/ {
        proxy_pass http://backend/chat;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Required for Vite's Hot Module Replacement (HMR) via WebSockets
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # Location block for the backend API
    # Any request starting with /api/ will be routed here.
    location /api/ {
        # This is CRUCIAL: it removes the '/api' prefix before forwarding
        # so your backend receives '/chat' instead of '/api/chat'.
        rewrite /api/(.*) /$1 break;
        
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}